---
title: "Patterns Overlaps 3 & 24"
author: "Philipp Heinrich"
date: "12022-03-20"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r}
base <- read_tsv("../instance/BREXIT_V20190522_DEDUP/query-results/pattern3.tsv.gz",
                 show_col_types = FALSE)
slot <- read_tsv("../instance/BREXIT_V20190522_DEDUP/query-results/pattern24.tsv.gz",
                 show_col_types = FALSE)
```

## read matches

```{r}
ids_both <- intersect(base$tweet_id, slot$tweet_id)
```

- base: `r nrow(base)` matches (`r length(unique(base$tweet_id))` unique tweets)
- slot: `r nrow(slot)`  matches (`r length(unique(slot$tweet_id))` unique tweets)
- co-occurrences: `r length(ids_both)`

## post-process and combine

```{r}
# BASE
base.tmp <- base %>% select(
  tweet_id,
  word,
  query,
  match,
  matchend,
  "0_START",
  "0_END",
  "1_START",
  "1_END"
)

# missing start or end
base.tmp[base.tmp[, "0_START"] == -1, "0_START"] <- base.tmp[base.tmp[, "0_START"] == -1, "0_END"]
base.tmp[base.tmp[, "0_END"] == -1, "0_END"] <- base.tmp[base.tmp[, "0_END"] == -1, "0_START"]
base.tmp[base.tmp[, "1_START"] == -1, "1_START"] <- base.tmp[base.tmp[, "1_START"] == -1, "1_END"]
base.tmp[base.tmp[, "1_END"] == -1, "1_END"] <- base.tmp[base.tmp[, "1_END"] == -1, "1_START"]

# SLOT
slot.tmp <- slot %>% select(
  tweet_id,
  query,
  match,
  matchend,
  "0_START",
  "0_END",
  "1_START",
  "1_END"
)

slot.tmp[slot.tmp[, "0_START"] == -1, "0_START"] <- slot.tmp[slot.tmp[, "0_START"] == -1, "0_END"]
slot.tmp[slot.tmp[, "0_END"] == -1, "0_END"] <- slot.tmp[slot.tmp[, "0_END"] == -1, "0_START"]
slot.tmp[slot.tmp[, "1_START"] == -1, "1_START"] <- slot.tmp[slot.tmp[, "1_START"] == -1, "1_END"]
slot.tmp[slot.tmp[, "1_END"] == -1, "1_END"] <- slot.tmp[slot.tmp[, "1_END"] == -1, "1_START"]

# combine
both <- base.tmp %>% inner_join(slot.tmp, by = "tweet_id", suffix = c("", "_slot"))
```

## calculate overlaps
```{r}
both <- both %>% mutate(
  
  # SLOT 0
  
  # whole match of slot query
  exact0 = (
    (match_slot == `0_START`) & (matchend_slot == `0_END`)
  ),
  within0 = (
    (match_slot >= `0_START`) 
    & (match_slot <= `0_END`) 
    & (matchend_slot >= `0_START`) 
    & (matchend_slot <= `0_END`)
    & ! exact0
  ),
  overlap0 = (
    (((match_slot >= `0_START`) & (match_slot <= `0_END`))
    | ((matchend_slot >= `0_START`) & (matchend_slot <= `0_END`)))
    & ! exact0 & ! within0
  ),
  outside0 = ! exact0 & ! within0 & ! overlap0,
  
  # slot 0 of slot query
  exact0_0 = (
    (`0_START_slot` == `0_START`) & (`0_END_slot` == `0_END`)
  ),
  within0_0 = (
    (`0_START_slot` >= `0_START`) 
    & (`0_START_slot` <= `0_END`) 
    & (`0_END_slot` >= `0_START`) 
    & (`0_END_slot` <= `0_END`)
    & ! exact0_0
  ),
  overlap0_0 = (
    (((`0_START_slot` >= `0_START`) & (`0_START_slot` <= `0_END`))
    | ((`0_END_slot` >= `0_START`) & (`0_END_slot` <= `0_END`)))
    & ! exact0_0 & ! within0_0
  ),
  outside0_0 = ! exact0_0 & ! within0_0 & ! overlap0_0,
  
  # slot 1 of slot query
  exact0_1 = (
    (`0_START_slot` == `0_START`) & (`0_END_slot` == `0_END`)
  ),
  within0_1 = (
    (`1_START_slot` >= `0_START`) 
    & (`1_START_slot` <= `0_END`) 
    & (`1_END_slot` >= `0_START`) 
    & (`1_END_slot` <= `0_END`)
    & ! exact0_1
  ),
  overlap0_1 = (
    (((`1_START_slot` >= `0_START`) & (`1_START_slot` <= `0_END`))
    | ((`1_END_slot` >= `0_START`) & (`1_END_slot` <= `0_END`)))
    & ! exact0_1 & ! within0_1
  ),
  outside0_1 = ! exact0_1 & ! within0_1 & ! overlap0_1,
  
  # SLOT 1
  
  # whole match of slot query
  exact1 = (
    (match_slot == `1_START`) & (matchend_slot == `1_END`)
  ),
  within1 = (
    (match_slot >= `1_START`) 
    & (match_slot <= `1_END`) 
    & (matchend_slot >= `1_START`) 
    & (matchend_slot <= `1_END`)
    & ! exact1
  ),
  overlap1 = (
    (((match_slot >= `1_START`) & (match_slot <= `1_END`))
    | ((matchend_slot >= `1_START`) & (matchend_slot <= `1_END`))) 
    & ! exact1 & ! within1
  ),
  outside1 = ! exact1 & ! within1 & ! overlap1,

  # slot 0 of slot query
  exact1_0 = (
    (`0_START_slot` == `1_START`) & (`0_END_slot` == `1_END`)
  ),
  within1_0 = (
    (`0_START_slot` >= `1_START`) 
    & (`0_START_slot` <= `1_END`) 
    & (`0_END_slot` >= `1_START`) 
    & (`0_END_slot` <= `1_END`)
    & ! exact1_0
  ),
  overlap1_0 = (
    (((`0_START_slot` >= `1_START`) & (`0_START_slot` <= `1_END`))
    | ((`0_END_slot` >= `1_START`) & (`0_END_slot` <= `1_END`)))
    & ! exact1_0 & ! within1_0
  ),
  outside1_0 = ! exact1_0 & ! within1_0 & ! overlap1_0,
  
  # slot 1 of slot query
  exact1_1 = (
    (`1_START_slot` == `1_START`) & (`1_END_slot` == `1_END`)
  ),
  within1_1 = (
    (`1_START_slot` >= `1_START`) 
    & (`1_START_slot` <= `1_END`) 
    & (`1_END_slot` >= `1_START`) 
    & (`1_END_slot` <= `1_END`)
    & ! exact1_1
  ),
  overlap1_1 = (
    (((`1_START_slot` >= `1_START`) & (`1_START_slot` <= `1_END`))
    | ((`1_END_slot` >= `1_START`) & (`1_END_slot` <= `1_END`)))
    & ! exact1_1 & ! within1_1
  ),
  outside1_1 = ! exact1_1 & ! within1_1 & ! overlap1_1
)
```


## overview

### slot 0 of base query
#### match of slot query
```{r}
tibble(
  typ = c("exact0", "within0", "overlap0", "outside0"),
  count = c(sum(both$exact0), sum(both$within0), sum(both$overlap0), sum(both$outside0))
)
```

#### slot 0 of slot query
```{r}
tibble(
  typ = c("exact0_0", "within0_0", "overlap0_0", "outside0_0"),
  count = c(sum(both$exact0_0), sum(both$within0_0), sum(both$overlap0_0), sum(both$outside0))
)
```

#### slot 1 of slot query
```{r}
tibble(
  typ = c("exact0_1", "within0_1", "overlap0_1", "outside0_1"),
  count = c(sum(both$exact0_1), sum(both$within0_1), sum(both$overlap0_1), sum(both$outside0_1))
)
```

### slot 1 of base query
#### match of slot query
```{r}
tibble(
  typ = c("exact1", "within1", "overlap1", "outside1"),
  count = c(sum(both$exact1), sum(both$within1), sum(both$overlap1), sum(both$outside1))
)
```

#### slot 0 of slot query
```{r}
tibble(
  typ = c("exact1_0", "within1_0", "overlap1_0", "outside1_0"),
  count = c(sum(both$exact1_0), sum(both$within1_0), sum(both$overlap1_0), sum(both$outside1_0))
)
```

#### slot 1 of slot query
```{r}
tibble(
  typ = c("exact1_1", "within1_1", "overlap1_1", "outside1_1"),
  count = c(sum(both$exact1_1), sum(both$within1_1), sum(both$overlap1_1), sum(both$outside1_1))
)

```

```{r}
View(both)
```
